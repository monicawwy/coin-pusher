<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Double Layer Coin Pusher</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>

    <!-- è£é£¾èƒŒæ™¯ -->
    <div class="bg-pattern"></div>

    <!-- é ‚éƒ¨è³‡è¨Š -->
    <div class="header-ui">
        <div class="jackpot-box">
            <div class="label">JACKPOT</div>
            <div class="value" id="jackpot">10,000</div>
        </div>
    </div>

    <!-- è€è™æ©Ÿé¡¯ç¤º (æµ®å‹•åœ¨ç•«é¢ä¸Šæ–¹) -->
    <div class="slot-display">
        <div class="reel" id="r1">ğŸ’</div>
        <div class="reel" id="r2">ğŸ’</div>
        <div class="reel" id="r3">ğŸ’</div>
        <div id="win-text">PUSH!</div>
    </div>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <div id="game-container"></div>

    <!-- åº•éƒ¨æŒ‰éˆ• -->
    <div class="controls-area">
        <div class="score-board">
            WIN: <span id="score">0</span>
        </div>
        <button id="drop-btn" class="big-red-btn">
            <span class="btn-text">DROP COIN</span>
            <span class="btn-shine"></span>
        </button>
    </div>

    <script>
        // --- éŸ³æ•ˆç³»çµ± ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            if (type === 'drop') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start();
                osc.stop(now + 0.1);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(600, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start();
                osc.stop(now + 0.5);
            }
        }

        // --- Matter.js è¨­å®š ---
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              Body = Matter.Body,
              Vector = Matter.Vector;

        const engine = Engine.create();
        const world = engine.world;

        // è¨­å®šé‡åŠ›ï¼šYè»¸å‘ä¸‹ï¼Œæ¨¡æ“¬çœŸå¯¦æ‰è½
        engine.world.gravity.y = 1.0; 
        
        const width = window.innerWidth;
        const height = window.innerHeight - 140; // æ‰£é™¤åº•éƒ¨æŒ‰éˆ•

        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: {
                width: width,
                height: height,
                wireframes: false,
                background: 'transparent',
                pixelRatio: window.devicePixelRatio
            }
        });

        // --- åƒæ•¸è¨­å®š ---
        const categories = {
            default: 0x0001,
            pusher: 0x0002,
            coin: 0x0004
        };

        // --- æ§‹å»ºå ´æ™¯ ---

        // 1. ç‰†å£
        const walls = [
            Bodies.rectangle(-10, height/2, 20, height * 2, { isStatic: true }), // å·¦
            Bodies.rectangle(width+10, height/2, 20, height * 2, { isStatic: true }), // å³
        ];
        Composite.add(world, walls);

        // 2. é»é»å€åŸŸ (Plinko Pegs) - ä½æ–¼é ‚éƒ¨
        const pegRows = 3;
        const pegCols = 5;
        const pegStartY = 80;
        for (let i = 0; i < pegRows; i++) {
            for (let j = 0; j < pegCols; j++) {
                let x = (width / pegCols) * j + (width / pegCols) / 2;
                // äº¤éŒ¯æ’åˆ—
                if (i % 2 === 0) x += 20;
                
                const peg = Bodies.circle(x, pegStartY + i * 50, 6, {
                    isStatic: true,
                    render: { fillStyle: '#fff' },
                    restitution: 0.8
                });
                Composite.add(world, peg);
            }
        }

        // 3. æ¨æ¿çµæ§‹ (é›™å±¤)
        // æˆ‘å€‘éœ€è¦ "åœ°æ¿" (static) å’Œ "æ¨å‹•å¡Š" (moving)
        
        // ä¸Šå±¤è¨­å®š
        const upperY = height * 0.45;
        const upperDepth = 150;
        // ä¸Šå±¤åœ°æ¿ (æ‰¿æ¥å¾é»é»æ‰ä¸‹ä¾†çš„)
        const upperFloor = Bodies.rectangle(width/2, upperY, width * 0.7, 10, { 
            isStatic: true,
            render: { fillStyle: '#4a0e0e' }, // æ·±ç´…åœ°æ¿
            friction: 0.1
        });
        // ä¸Šå±¤æ¨å‹•å¡Š
        const pusherUpper = Bodies.rectangle(width/2, upperY - 30, width * 0.7, 50, {
            isStatic: true, // æˆ‘å€‘æ‰‹å‹•æ§åˆ¶ä½ç½®
            render: { fillStyle: '#d4af37' } // é‡‘è‰²æ¨æ¿
        });

        // ä¸‹å±¤è¨­å®š
        const lowerY = height * 0.75;
        // ä¸‹å±¤åœ°æ¿ (æ‰¿æ¥ä¸Šå±¤æ¨ä¸‹ä¾†çš„)
        const lowerFloor = Bodies.rectangle(width/2, lowerY, width * 0.9, 10, { 
            isStatic: true,
            render: { fillStyle: '#4a0e0e' },
            friction: 0.1
        });
        // ä¸‹å±¤æ¨å‹•å¡Š
        const pusherLower = Bodies.rectangle(width/2, lowerY - 30, width * 0.9, 50, {
            isStatic: true,
            render: { fillStyle: '#c0c0c0' } // éŠ€è‰²æ¨æ¿
        });

        Composite.add(world, [upperFloor, pusherUpper, lowerFloor, pusherLower]);

        // --- é‚è¼¯æ§åˆ¶ ---
        
        let time = 0;
        // é›¨åˆ·è®Šæ•¸
        let wiperX = width / 2;
        const wiperY = 30;
        const wiperRange = width * 0.35; // é›¨åˆ·ç§»å‹•ç¯„åœ

        Events.on(engine, 'beforeUpdate', function(event) {
            time += 0.02;

            // 1. æ›´æ–°é›¨åˆ·ä½ç½®
            wiperX = (width / 2) + Math.sin(time * 1.5) * wiperRange;

            // 2. æ›´æ–°æ¨æ¿ç§»å‹• (å‰å¾Œç§»å‹•)
            // ä¸Šå±¤æ¨æ¿é‚è¼¯ï¼šä¸æœƒé›¢é–‹æ©Ÿèº«ï¼Œåªåœ¨å¾ŒåŠæ®µç§»å‹•
            // ä¸Šå±¤åœ°æ¿ä¸­å¿ƒåœ¨ width/2, Y=upperY.
            // æˆ‘å€‘è®“æ¨æ¿åœ¨ Zè»¸ (é€™è£¡æ˜¯æ¨¡æ“¬çš„ Yè»¸æ·±åº¦) ç§»å‹•
            // åœ¨ 2D å´é¢è¦–åœ–ä¸­ï¼Œé€™å…¶å¯¦å¾ˆé›£å®Œç¾è¡¨ç¾ã€‚
            // ç‚ºäº†æ¨¡æ“¬æˆªåœ–æ•ˆæœï¼Œæˆ‘å€‘è®“æ¨æ¿ "å·¦å³" æˆ– "ä¸Šä¸‹" å¾®å‹•æ˜¯æ²’ç”¨çš„ã€‚
            // è§£æ±ºæ–¹æ¡ˆï¼šé€™æ˜¯ä¸€å€‹ä¿¯è¦–+å´è¦–æ··åˆã€‚
            // ç‚ºäº†è®“éŠ€ä»”è¢«æ¨ä¸‹å»ï¼Œæˆ‘å€‘è®“æ¨æ¿åš "æ´»å¡é‹å‹•" æƒéåœ°æ¿è¡¨é¢ã€‚
            
            // ä¸Šå±¤æ¨æ¿é‹å‹• (åœ¨ Floor ä¸Šæ–¹æ»‘å‹•)
            // åŸå§‹ä½ç½®: upperFloor.position
            // æˆ‘å€‘è®“æ¨æ¿çš„ Y åº§æ¨™è®ŠåŒ–ï¼Œæ¨¡æ“¬å‰å¾Œ
            // æ³¨æ„ï¼šå› ç‚ºé€™æ˜¯ 2D ç‰©ç†ï¼Œæˆ‘å€‘å…¶å¯¦æ˜¯ç”¨ä¸€å€‹æ–¹å¡ŠæŠŠéŠ€ä»”ã€Œæ¨ã€ä¸‹å¹³å°é‚Šç·£
            
            const pushOffset = Math.sin(time) * 40; // ç§»å‹•ç¯„åœ 40px
            
            // ä¸Šå±¤æ¨æ¿ä½ç½®è¨­å®šï¼š
            // å®ƒçš„ä¸­å¿ƒé» Y æ‡‰è©²åœ¨ åœ°æ¿Y æ¸›å»é«˜åº¦ï¼Œå†åŠ ç§»å‹•é‡
            // ç‚ºäº†ä¸è®“æ¨æ¿ã€Œé›¢é–‹ã€ï¼Œæˆ‘å€‘è¨­å®šä¸­å¿ƒé»åŸºæº–ç¨å¾®é å¾Œ
            const pUpBaseY = upperY - 40; // åœ°æ¿ä¸Šæ–¹
            // ä½† MatterJS é è¨­æ˜¯å‰›é«”ç¢°æ’ã€‚å¦‚æœæ¨æ¿åœ¨éŠ€ä»”ä¸Šæ–¹ç§»å‹•ï¼Œæœƒå£“æ‰éŠ€ä»”ã€‚
            // é€™è£¡æ¡ç”¨ "Side View" é‚è¼¯ï¼š
            // éŠ€ä»”è½åœ¨ Floor ä¸Šã€‚Pusher æ˜¯ä¸€å€‹ç‰†ï¼Œåœ¨ Floor ä¸Šå·¦å³(æˆ–å‰å¾Œ)ç§»å‹•ã€‚
            // ä¿®æ­£ï¼šæˆ‘å€‘çš„è¦–è§’æ˜¯ "Front View" (æ­£è¦–)ã€‚
            // ä½†æ¨éŠ€æ©Ÿçš„ç‰©ç†å¿…é ˆæ˜¯ "Top Down" (ä¿¯è¦–) æ‰èƒ½çœ‹åˆ°æ¨çš„å‹•ä½œï¼Œ
            // æˆ–è€… "Side View" (å´è¦–) æ‰èƒ½çœ‹åˆ°æ‰è½ã€‚
            
            // ** é—œéµæ··åˆæ–¹æ¡ˆ **ï¼š
            // æˆ‘å€‘ä¿æŒ Side View (é‡åŠ›å‘ä¸‹)ã€‚
            // æ¨æ¿ (Pusher) ä¸æ˜¯ä¸Šä¸‹ç§»å‹•ï¼Œè€Œæ˜¯ã€ŒèƒŒæ™¯ç‰†ã€å¾€å‰æ¨ï¼Ÿä¸ï¼Œé€™åœ¨ 2D åšä¸åˆ°ã€‚
            // æˆ‘å€‘å°‡æ¡ç”¨ï¼šæ¨æ¿æ˜¯å¯¦é«”æ–¹å¡Šï¼Œåœ¨å¹³å°è¡¨é¢ "æ°´å¹³(Xè»¸)" æˆ– "å‚ç›´(Yè»¸)"ï¼Ÿ
            // ä¾ç…§ä½ çš„æˆªåœ–ï¼Œé€™æ˜¯ 3D é€è¦–ã€‚
            // åœ¨ 2D ç‰©ç†å¼•æ“ä¸­æœ€æ¥è¿‘çš„æ¨¡æ“¬æ˜¯ï¼š
            // 1. éŠ€ä»”æ‰ä¸‹ä¾† (Yè»¸å‘ä¸‹)ã€‚
            // 2. ç¢°åˆ°å¹³å° (Static)ã€‚
            // 3. æ¨æ¿æ˜¯ä¸€å€‹ã€Œæ´»å¡ã€ï¼Œæ²¿è‘— X è»¸æˆ– Z è»¸æ¨ã€‚
            // æ—¢ç„¶æˆªåœ–æ˜¯æ­£è¦–åœ–ï¼Œæ¨æ¿æ‡‰è©²æ˜¯ã€Œå¾è¢å¹•å…§å´å¾€å¤–æ¨ã€ã€‚
            // é€™åœ¨ 2D å¼•æ“ç„¡æ³•ç›´æ¥åšã€‚
            
            // ** ä¿®æ”¹æ–¹æ¡ˆ **ï¼š
            // è®“æ¨æ¿åœ¨ Y è»¸ä¸Šåšå¾®å°çš„ä¸Šä¸‹éœ‡å‹•ï¼Œé…åˆæ‘©æ“¦åŠ›ï¼ŒæŠŠéŠ€ä»”ã€Œæ“ ã€å‡ºå»ã€‚
            // æˆ–è€…ï¼Œæˆ‘å€‘åœ¨å¹³å°ä¸Šæ–¹åŠ ä¸€å€‹ä¸å¯è¦‹çš„æ–œå¡åŠ›å ´ã€‚
            
            // ç‚ºäº†æœ€åƒçœŸå¯¦æ©Ÿå™¨ï¼š
            // æˆ‘å€‘è®“æ¨æ¿ (pusherUpper) åœ¨ Y è»¸ä¸Šç§»å‹•ã€‚
            // åˆå§‹ä½ç½®åœ¨å¹³å°å¾Œæ–¹ã€‚
            // ç§»å‹•ç¯„åœï¼šå¾ (å¹³å°ä¸­å¿ƒ - 50) åˆ° (å¹³å°ä¸­å¿ƒ + 20)ã€‚
            // ç•¶æ¨æ¿å‘ä¸‹ç§»å‹• (Yå¢åŠ )ï¼Œå®ƒæœƒæ¨å‹•éŠ€ä»”ã€‚
            // ç•¶æ¨æ¿å‘ä¸Šç§»å‹• (Yæ¸›å°‘)ï¼Œå®ƒç¸®å›å»ï¼ŒéŠ€ä»”ç•™åœ¨åŸåœ° (å› ç‚ºæ‘©æ“¦)ã€‚
            
            // ä¸Šå±¤
            Body.setPosition(pusherUpper, { 
                x: width/2, 
                y: (upperY - 50) + Math.abs(Math.sin(time)) * 40 
            });

            // ä¸‹å±¤ (åç›¸ç§»å‹•)
            Body.setPosition(pusherLower, { 
                x: width/2, 
                y: (lowerY - 50) + Math.abs(Math.sin(time + Math.PI)) * 40 
            });

            // 3. æ¸…ç†æ‰è½çš„éŠ€ä»” (å¾—åˆ†)
            const bodies = Composite.allBodies(world);
            for (let body of bodies) {
                if (body.label === 'coin' && body.position.y > height + 50) {
                    addScore(1);
                    Composite.remove(world, body);
                }
            }
        });

        // --- éŠ€ä»”ç”Ÿæˆ ---
        function spawnCoin(x, y, isInit = false) {
            const coin = Bodies.circle(x, y, 12, { // 24px ç›´å¾‘
                label: 'coin',
                restitution: 0.1, // ä½å½ˆæ€§ï¼Œä¸åƒå½ˆç 
                friction: 0.05,   // äº›å¾®æ‘©æ“¦
                density: 0.005,   // è¼ƒé‡
                render: {
                    sprite: {
                        // å¦‚æœæ²’æœ‰åœ–ç‰‡ï¼ŒMatterJS æœƒç”¨é¡è‰²
                        texture: '' 
                    },
                    fillStyle: '#ffd700',
                    strokeStyle: '#b8860b',
                    lineWidth: 2
                }
            });
            Composite.add(world, coin);
        }

        // --- åˆå§‹åŒ–ï¼šé‹ªæ»¿éŠ€ä»” ---
        function initCoins() {
            // ä¸Šå±¤é‹ªæ»¿
            for(let i=0; i<50; i++) {
                // éš¨æ©Ÿåˆ†ä½ˆåœ¨ä¸Šå±¤åœ°æ¿ç¯„åœå…§
                const x = (width/2 - 100) + Math.random() * 200;
                const y = upperY - 20 - Math.random() * 100;
                spawnCoin(x, y, true);
            }
            // ä¸‹å±¤é‹ªæ»¿
            for(let i=0; i<60; i++) {
                const x = (width/2 - 150) + Math.random() * 300;
                const y = lowerY - 20 - Math.random() * 100;
                spawnCoin(x, y, true);
            }
        }

        // --- äº’å‹•èˆ‡éŠæˆ²é‚è¼¯ ---
        let score = 0;
        const scoreEl = document.getElementById('score');
        
        function addScore(val) {
            score += val;
            scoreEl.innerText = score;
        }

        // æŒ‰éˆ•äº‹ä»¶
        const btn = document.getElementById('drop-btn');
        btn.addEventListener('touchstart', dropCoin, {passive:false});
        btn.addEventListener('click', dropCoin);

        function dropCoin(e) {
            e.preventDefault();
            // æŒ‰éˆ•å‹•ç•«
            btn.style.transform = 'scale(0.95)';
            setTimeout(()=>btn.style.transform='scale(1)', 100);

            // å¾é›¨åˆ·ä½ç½®ç”Ÿæˆ
            playSound('drop');
            spawnCoin(wiperX, wiperY + 20);
            
            // è§¸ç™¼è€è™æ©Ÿ
            spinSlot();
        }

        // è€è™æ©Ÿ
        const r1 = document.getElementById('r1');
        const r2 = document.getElementById('r2');
        const r3 = document.getElementById('r3');
        const winText = document.getElementById('win-text');
        const symbols = ['ğŸ’','7ï¸âƒ£','ğŸ’','ğŸ‘‘','ğŸ””'];

        let isSpinning = false;

        function spinSlot() {
            if(isSpinning) return;
            isSpinning = true;
            winText.innerText = "SPINNING...";
            winText.style.color = "#fff";

            let count = 0;
            const interval = setInterval(() => {
                r1.innerText = symbols[Math.floor(Math.random()*symbols.length)];
                r2.innerText = symbols[Math.floor(Math.random()*symbols.length)];
                r3.innerText = symbols[Math.floor(Math.random()*symbols.length)];
                count++;
                if(count > 15) {
                    clearInterval(interval);
                    checkResult();
                }
            }, 80);
        }

        function checkResult() {
            isSpinning = false;
            // 30% ä¸­çç‡
            if(Math.random() < 0.3) {
                const sym = symbols[Math.floor(Math.random()*symbols.length)];
                r1.innerText = sym; r2.innerText = sym; r3.innerText = sym;
                
                winText.innerText = "WINNER!";
                winText.style.color = "#ff0055";
                playSound('win');

                // çå‹µï¼šå¾ä¸Šå±¤éš¨æ©Ÿæ‰è½ä¸€å †
                let reward = Math.floor(Math.random() * 30) + 20; // 20-50 coins
                let drops = 0;
                const dropInt = setInterval(() => {
                    spawnCoin(wiperX + (Math.random()*40-20), wiperY);
                    drops++;
                    if(drops >= reward) clearInterval(dropInt);
                }, 100);
            } else {
                winText.innerText = "TRY AGAIN";
            }
        }

        // --- å•Ÿå‹•èˆ‡è‡ªå®šç¾©ç¹ªåœ– ---
        Render.run(render);
        Runner.run(Runner.create(), engine);
        initCoins();

        // ç¹ªè£½é›¨åˆ· (åœ¨ Canvas ä¹‹ä¸Š)
        Events.on(render, 'afterRender', function() {
            const ctx = render.context;
            
            // ç•«é›¨åˆ·
            ctx.save();
            ctx.translate(wiperX, wiperY);
            ctx.fillStyle = '#00ff00'; // è¢å…‰ç¶ é›¨åˆ·
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ff00';
            
            // å€’ä¸‰è§’
            ctx.beginPath();
            ctx.moveTo(-10, 0);
            ctx.lineTo(10, 0);
            ctx.lineTo(0, 20);
            ctx.fill();
            
            // é€£æ¡¿
            ctx.fillStyle = '#555';
            ctx.fillRect(-2, -100, 4, 100); // å‘ä¸Šå»¶ä¼¸çš„æ¡¿å­
            ctx.restore();

            // ç‚ºäº†è¦–è¦ºç¾è§€ï¼Œæˆ‘å€‘åœ¨æ¨æ¿ä¸Šç•«é»è£é£¾
            // ä¸Šå±¤æ¨æ¿
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(pusherUpper.position.x - width*0.35, pusherUpper.position.y - 25, width*0.7, 50);
        });

    </script>
</body>
</html>
